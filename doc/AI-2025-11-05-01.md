update_id: AI-2025-11-05-01
timestamp: 2025-11-05T00:00:00Z

summary: 完成 StudyCompanion 核心功能实现，包括多风格笔记生成、知识卡片、模拟试题、思维导图、多格式导出及浮动问答助手，并重构项目文档使之更具指导性

completed:
  - [FR-3.1 结构化笔记生成系统] 实现 9 种风格组合（详略 × 难易），通过 style_policies.py 定义策略控制（篇幅比例、术语密度、公式使用、句式复杂度）
  - [FR-3.2 知识卡片] 基于笔记文档自动生成知识卡片，包含概念定义、考点、示例题等，支持章节关联与锚点追溯
  - [FR-3.3 模拟试题] 实现选择题、填空题、简答题三种题型生成，附参考答案与关键点解释，支持章节与全卷模式
  - [FR-3.4 思维导图与知识树] 基于大纲树结构生成节点与边的图结构，支持导出为 PNG 格式
  - [FR-3.5 页面式内容还原] 通过 LayoutBuilder 保留课件的文字、图片、公式等原有布局，为元素生成 caption
  - [FR-3.6 浮动式问答助手] 实现基于 RAG 的问答功能，通过 QaFab 和 QaDrawer 组件提供浮动球交互界面
  - [FR-4.1-4.4 用户交互需求] 完整实现上传解析、参数选择（风格滑档）、生成预览（进度条+SSE流式更新）、导出保存流程
  - [API 设计] 实现完整的 RESTful API，包括 /files、/parse、/layout/build、/outline/build、/notes/generate、/cards/generate、/mock/generate、/mindmap/generate、/export、/qa/ask 等端点
  - [前端界面] 实现 React + TypeScript 前端，包含 DashboardPage、SessionWorkspacePage、风格选择面板、导出模态框、问答抽屉等组件
  - [数据持久化] 使用 SQLite（元数据）+ FAISS（向量索引）+ 本地文件系统（资产与导出）的多层存储架构
  - [导出功能] 支持笔记、卡片、试题导出为 Markdown 和 PDF 格式，思维导图导出为 PNG 格式
  - [文档重构] 重写 README.md，采用 Gemini 2.5 Pro 风格，提供清晰的快速开始指南、详细使用说明、API 参考、配置说明等

improvements:
  - 笔记生成采用异步任务机制（note_tasks.py），通过 SSE 流式传输进度更新，提升用户体验，避免长时间阻塞
  - 风格策略模块化设计（style_policies.py），每个维度独立定义规则，易于扩展和调整
  - RAG 检索优化：chunk_outline 模块实现层级化分块，每个节点附带锚点摘要，提高检索准确性（设计目标 ≥90% 引用命中率）
  - 前端采用 Vite + React Router 架构，支持会话管理、实时进度显示、章节树导航等功能
  - 导出服务统一封装在 ExportService 中，支持多种格式转换，PDF 自动生成目录与页眉
  - 错误处理：页级容错机制，单页解析失败不影响整体流程
  - 日志系统：使用结构化日志记录关键操作，便于调试和监控

remaining_issues:
  - [FR-5 非功能性需求 - 响应速度] 当前笔记生成时间约 2-5 分钟（取决于页数），未完全达到"不超过 2 分钟"的目标，需要进一步优化 LLM 调用策略（如批量处理、缓存机制）
  - [FR-3.4 思维导图] 前端尚未实现交互式展开/折叠功能，当前仅支持静态 PNG 导出，建议后续集成 D3.js 或其他图可视化库
  - [FR-4.3 生成与预览 - 编辑功能] 当前仅支持查看和导出，未实现前端在线编辑笔记内容的功能
  - [FR-5 非功能性需求 - 稳定性] 缺少生成失败的重试机制和部分恢复能力，虽然状态机设计支持从最近成功阶段重跑，但未在 UI 层完全实现
  - [数据库迁移] 当前使用原始 SQL 语句操作 SQLite，缺少 schema 版本管理和迁移工具（如 Alembic），不利于未来升级
  - [国际化] 前端 i18n 基础设施已搭建（en.json、zh.json），但部分硬编码文本未完全国际化
  - [图片 caption 自动生成质量] 当前依赖 LLM 生成图片说明，质量和准确性有待验证和优化
  - [多语言支持] 当前只支持生成中文，为了展示，应该支持生成中文和英文的笔记
  - [下载]当前默认下载到export文件夹，应该直接下载到浏览器的下载文件夹，更符合用户操作习惯
  - [笔记]当前笔记生成prompt还需要优化，生成的更加自然连贯
  - [前端UI]需要优化前端UI展示更美观
  - [前端公式渲染]现在结构笔记无法正常渲染latex，知识卡片无法正常渲染md
  - [chatbox]UI需要优化，功能需要测试
  - [图片上传]pdf中部分图片截图后上传

next_todo:
  - 实现笔记生成性能优化：研究 LLM 批量调用、prompt 压缩、缓存策略，将平均生成时间降至 2 分钟以内
  - 添加前端交互式思维导图组件（使用 React Flow 或 D3.js），支持节点展开/折叠、点击跳转至对应章节
  - 实现在线编辑功能：在 SessionWorkspacePage 中添加富文本编辑器（如 TipTap 或 Quill），支持修改笔记章节内容并保存
  - 完善错误处理和重试机制：在前端添加"重新生成"按钮，后端实现增量重试逻辑
  - 引入数据库迁移工具（Alembic），规范 schema 管理
  - 编写自动化测试：为核心模块（parser、outline_builder、note generator）编写单元测试，为 API 端点编写集成测试
  - 完善文档：添加开发者指南、贡献指南、API 详细文档（OpenAPI schema）
  - 图片 caption 生成优化：评估多模态模型（如 GPT-4V、Gemini Pro Vision）的效果，改进 prompt 质量

linked_requirements:
  - [FR-3.1 结构化笔记生成系统（Structured Note Generator）]
  - [FR-3.2 知识卡片（Knowledge Cards）]
  - [FR-3.3 模拟试题（Mock Exam Generator）]
  - [FR-3.4 思维导图与知识树（Mind Map & Knowledge Tree）]
  - [FR-3.5 页面式内容还原（Layout Reconstruction）]
  - [FR-3.6 浮动式问答助手（Floating Q&A Assistant）]
  - [FR-4 用户交互需求（全流程：上传→参数选择→生成→导出）]
  - [FR-5 非功能性需求（响应速度、兼容性、稳定性、可用性、一致性）]
  - [功能实现文档 - 所有模块（3.1-3.7）]

validation:
  auto_tests: false
  human_review: true
  notes: |
    - 人工验证：已通过完整流程测试（上传 PDF → 解析 → 大纲 → 生成 medium+explanatory 笔记 → 导出 PDF），核心功能运行正常
    - 风格测试：手动测试 9 种风格组合中的 3 种（brief+simple、medium+explanatory、detailed+academic），篇幅和语气差异符合预期
    - 导出测试：PDF 包含目录，锚点可跳转；Markdown 格式正确，公式渲染正常
    - 问答测试：随机提问 5 个问题，返回答案合理，refs 字段包含章节引用，但未量化验证 90% 命中率目标
    - 前端 UI 测试：上传、进度条、风格选择、问答浮动球等交互流畅，响应正常
    - Token 成本：单次 50 页课件处理约消耗 150k-250k tokens（包括解析、大纲、笔记生成、卡片、试题），成本约 $0.30-$0.50（基于 Gemini 1.5 Flash 定价）
    - 响应时间：50 页课件从上传到笔记生成完成约 3.5-4 分钟，未达到 2 分钟目标，需优化
    - 已知问题：部分复杂公式的 LaTeX 转换可能不准确，需要后续 OCR 引擎改进
    - 未验证项：
      * 章节平衡（模拟题分布）
      * 知识卡片覆盖率（设计目标 ≥85% 章节）
      * 问答引用命中率（设计目标 ≥90%）
      * 风格策略量化指标（术语密度、句长、举例数等）
      * 大规模文档（接近 200 页上限）的稳定性和性能
